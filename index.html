<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cədvəl</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="manifest" href="site.webmanifest">
    <meta name="theme-color" content="#111827">
    <style>
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-200 antialiased font-sans">
    <header class="bg-gray-800 border-b-4 border-blue-500 text-white font-bold p-4 text-2xl text-center shadow-lg">
        758/ITS</header>

    <nav class="flex flex-wrap justify-center items-center gap-3 my-6 px-4">
        <button onclick="showSection('kurs2Section')"
            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-5 rounded-full transition transform hover:scale-105 shadow-md">2-ci
            KURS</button>
        <button onclick="window.location.href='https://kenox7.github.io/herkes/'"
            class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-5 rounded-full transition transform hover:scale-105 shadow-md">Qayıblar</button>
        <button onclick="showSection('kurs1Section')"
            class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-5 rounded-full transition transform hover:scale-105 shadow-md">1-ci
            kurs</button>
        <button onclick="showSection('pdfsSection')"
            class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-5 rounded-full transition transform hover:scale-105 shadow-md">PDF</button>
        <button onclick="showSection('flappySection')"
            class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-5 rounded-full transition transform hover:scale-105 shadow-md">Flappy
            Ramin</button>
        <button onclick="showSection('bagikSection')"
            class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-5 rounded-full transition transform hover:scale-105 shadow-md">Bagik
            Run</button>
    </nav>

    <main class="container mx-auto px-4">
        <!-- Loader -->
        <div id="loader" class="text-center py-10 hidden">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-400"></div>
            <p class="mt-2 text-gray-400">Cədvəl yüklənir...</p>
        </div>

        <div id="kurs2Section" class="content">
            <h1
                class="text-4xl font-extrabold mb-2 text-center text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
                2-ci KURS CƏDVƏLİ</h1>
            <h3 id="weekType" class="text-xl text-center mb-6 text-yellow-400 font-semibold"></h3>
            <div id="schedule_kurs2" class="max-w-2xl mx-auto space-y-4"></div>

            <!-- Comments Section -->
            <div id="commentsSection" class="max-w-3xl mx-auto mt-12 pt-6 border-t border-gray-700">
                <h2 class="text-3xl font-bold mb-6 text-center text-blue-300">Qeydlər</h2>
                <form id="comment-form" class="flex flex-col md:flex-row gap-4 mb-6">
                    <input type="text" id="name-input" placeholder="Adın..." required
                        class="flex-grow bg-gray-700 border-2 border-gray-600 rounded-lg p-3 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" />
                    <input type="text" id="comment-input" placeholder="Fikrini yaz..." required
                        class="flex-grow bg-gray-700 border-2 border-gray-600 rounded-lg p-3 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" />
                    <button type="submit"
                        class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">Göndər</button>
                </form>
                <div id="comments-list"></div>
            </div>
        </div>

        <div id="kurs1Section" class="content hidden">
            <h1
                class="text-4xl font-extrabold mb-6 text-center text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
                1-ci KURS CƏDVƏLİ</h1>
            <div id="schedule_kurs1" class="max-w-2xl mx-auto"></div>
        </div>

        <div id="pdfsSection" class="content hidden">
            <!-- PDF Content (preserved) -->
            <div class="grid md:grid-cols-2 gap-6 max-w-5xl mx-auto">
                <div class="bg-gray-800 rounded-lg shadow-xl p-6 border border-gray-700">
                    <h3 class="text-xl font-bold mb-3 text-blue-300">English for Information Technology 1</h3>
                    <iframe id="pdf1" class="w-full h-96 rounded-md border-2 border-gray-600" loading="lazy"></iframe>
                    <div class="mt-4 flex gap-2">
                        <a id="pdf1-download" target="_blank"
                            class="w-full text-center bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full transition-colors">Yüklə</a>
                    </div>
                </div>
                <div class="bg-gray-800 rounded-lg shadow-xl p-6 border border-gray-700">
                    <h3 class="text-xl font-bold mb-3 text-blue-300">Murphy (qırmızı kitab)</h3>
                    <iframe id="pdf2" class="w-full h-96 rounded-md border-2 border-gray-600" loading="lazy"></iframe>
                    <div class="mt-4 flex gap-2">
                        <a id="pdf2-download" target="_blank"
                            class="w-full text-center bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full transition-colors">Yüklə</a>
                    </div>
                </div>
            </div>
        </div>

        <div id="flappySection" class="content hidden">
            <h1
                class="text-4xl font-extrabold mb-6 text-center text-center text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
                Flappy Ramin</h1>
            <div id="flappyContainer"
                class="aspect-video max-w-4xl mx-auto bg-gray-800 rounded-lg shadow-xl overflow-hidden border-2 border-gray-700">
            </div>
        </div>

        <div id="bagikSection" class="content hidden">
            <h1
                class="text-4xl font-extrabold mb-6 text-center text-center text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
                Bagik Run</h1>
            <div id="bagikContainer"
                class="aspect-video max-w-4xl mx-auto bg-gray-800 rounded-lg shadow-xl overflow-hidden border-2 border-gray-700">
            </div>
        </div>

        <!-- Comments Section (Merged from kohne.html) -->
        <div id="comments_container"></div>
        </div>
    </main>

    <footer class="text-center p-8 mt-10 text-gray-400">
        <p>@by Kenan</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { SystemManager } from "./firestore_manager.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAtQ_laoPhn_31RgUFp5hkHPzAcYJSH9_8",
            authDomain: "davamiyyet-sistemi.firebaseapp.com",
            databaseURL: "https://yorumlar-8f969-default-rtdb.firebaseio.com/",
            projectId: "davamiyyet-sistemi",
            storageBucket: "davamiyyet-sistemi.appspot.com",
            messagingSenderId: "773549402059",
            appId: "1:773549402059:web:25286906aa1d998041f84e",
            measurementId: "G-M3Y8QZCM8C"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const rtdb = getDatabase(app); // Realtime Database instance
        const manager = new SystemManager(db);
        const currentGroupId = "758_ITS";
        let currentSchedule = null;

        // --- Comments Logic ---
        const commentsRef = ref(rtdb, "comments");
        let clientId = localStorage.getItem('clientId');
        if (!clientId) {
            clientId = 'client-' + Math.random().toString(36).substring(2, 11);
            localStorage.setItem('clientId', clientId);
        }

        const commentForm = document.getElementById("comment-form");
        if (commentForm) {
            commentForm.addEventListener("submit", (e) => {
                e.preventDefault();
                const nameInput = document.getElementById("name-input");
                const commentInput = document.getElementById("comment-input");

                if (nameInput.value.trim() !== "" && commentInput.value.trim() !== "") {
                    push(commentsRef, {
                        name: nameInput.value,
                        text: commentInput.value,
                        timestamp: Date.now(),
                        clientId: clientId
                    });
                    nameInput.value = "";
                    commentInput.value = "";
                }
            });
        }

        onValue(commentsRef, (snapshot) => {
            const commentsList = document.getElementById("comments-list");
            if (!commentsList) return;

            commentsList.innerHTML = "";
            const commentsArray = [];
            snapshot.forEach((childSnapshot) => {
                commentsArray.push(childSnapshot.val());
            });

            commentsArray.sort((a, b) => b.timestamp - a.timestamp).forEach((data) => {
                const commentDiv = document.createElement("div");
                commentDiv.className = "bg-gray-800 p-4 rounded-lg mb-3 border border-gray-700";
                const date = new Date(data.timestamp);
                const formattedDate = date.toLocaleString("az-AZ", { dateStyle: 'medium', timeStyle: 'short' });
                commentDiv.innerHTML = `
            <p class="text-gray-200"><strong class="text-blue-300">${data.name}:</strong> ${data.text}</p>
            <small class="text-gray-500">${formattedDate}</small>
            `;
                commentsList.appendChild(commentDiv);
            });
        });

        async function init() {
            const loader = document.getElementById('loader');
            if (loader) loader.classList.remove('hidden');
            try {
                const semester = await manager.getActiveSemester();
                if (semester) {
                    currentSchedule = await manager.getGroupSchedule(semester.id, currentGroupId);
                    renderScheduleKurs2();
                } else {
                    const el = document.getElementById('schedule_kurs2');
                    if (el) el.innerHTML = "<p class='text-center text-gray-400'>Aktiv Semestr Yoxdur.</p>";
                }
            } catch (e) {
                console.error(e);
            } finally {
                if (loader) loader.classList.add('hidden');
            }
        }

        // --- Helpers ---
        const startDate = new Date("2024-02-24");
        function startOfDayCopy(d) {
            const c = new Date(d);
            c.setHours(0, 0, 0, 0);
            return c;
        }
        function hefteniTap(date) {
            const ref = startOfDayCopy(startDate);
            const d = startOfDayCopy(date);
            const diffMs = d.getTime() - ref.getTime();
            const diffWeeks = Math.floor(diffMs / (1000 * 60 * 60 * 24 * 7));
            return (diffWeeks % 2 === 0) ? "alt" : "ust";
        }
        function tarihFormatla(date) {
            const gunler = ["Bazar", "1-ci Gün<br> Bazar ertəsi", "2-ci Gün<br> Çərşənbə axşamı", "3-cü Gün<br> Çərşənbə", "4-cü Gün<br> Cümə axşamı", "5-ci Gün<br> Cümə", "Şənbə"];
            return `${gunler[date.getDay()]}, ${date.toLocaleDateString('az-AZ')}`;
        }

        // --- Render Logic ---

        function renderScheduleKurs2() {
            let container = document.getElementById("schedule_kurs2");
            if (!container) return;

            container.innerHTML = "";
            const bugun = new Date();
            const bugunWeekType = hefteniTap(bugun);
            const wtEl = document.getElementById("weekType");
            if (wtEl) wtEl.innerText = `Bu Həftə: ${bugunWeekType.toUpperCase()} Həftədir`;

            for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(bugun.getDate() + i);
                const dayIndex = date.getDay(); // 0-6

                if (dayIndex >= 1 && dayIndex <= 5) {
                    const type = hefteniTap(date);
                    const lessons = currentSchedule && currentSchedule[type] ? currentSchedule[type][dayIndex] : [];
                    const isToday = i === 0;

                    // HTML generation
                    const lessonHtml = (lessons && lessons.length > 0)
                        ? lessons.sort().map((l) => {
                            // Check for new format: "{Slot} Lesson..."
                            let display = l;
                            let slotNum = null;

                            if (l.startsWith('{')) {
                                const endIdx = l.indexOf('}');
                                slotNum = parseInt(l.substring(1, endIdx));
                                display = l.substring(endIdx + 1).trim();
                            }

                            // Check legacy numbering "1) ..."
                            const hasLegacyNumbering = /^\d+\)/.test(display);

                            // Shift-based Numbering Logic
                            let numberPrefix = "";
                            if (!hasLegacyNumbering && slotNum) {
                                const mappedNum = (slotNum > 3) ? (slotNum - 3) : slotNum;
                                numberPrefix = `${mappedNum}) `;
                            }

                            const finalStr = hasLegacyNumbering ? display : `${numberPrefix}${display}`;

                            return `<div class="bg-gray-700/50 p-3 rounded-lg mt-3 text-sm md:text-base">${finalStr}</div>`;
                        }).join('')
                        : "<p class='mt-2 text-gray-400'>Dərs yoxdur</p>";

                    container.innerHTML += `
                        <div class='bg-gray-800 p-5 rounded-xl shadow-lg border ${isToday ? 'border-blue-500 ring-2 ring-blue-500/20 scale-105' : 'border-gray-700'} transition-all'>
                            <div class="flex justify-between items-baseline mb-2">
                                <strong class="text-lg ${isToday ? 'text-blue-300' : 'text-gray-200'}">${tarihFormatla(date)}</strong>
                                <span class="text-xs font-mono px-2 py-1 rounded bg-gray-700 text-yellow-500">${type.toUpperCase()}</span>
                            </div>
                            <div class="space-y-2">${lessonHtml}</div>
                        </div>
                    `;
                }
            }
        }

        // --- Kurs 1 Static (Legacy) ---
        const dersCedveliKurs1 = {
            "alt": { 1: ["1)IT əsasları (seminar) - Kazımov Ramin", "2)Diferensial tənliklər (mühazirə) - Eyyubov Ramazan", "3)Fizika (mühazirə) - Əlizadə Leyla"], 2: ["1)Xətti cəbr (seminar) - Səmədzadə Fərahim", "2)XDİAK-2 (seminar) - Abbasova Nuridə"], 3: ["2)XDİAK-2 (seminar) - Abbasova Nuridə", "3)IT əsasları-2 (mühazirə) - Kazımov Ramin"], 4: ["3)İnstrumental proqramlar (seminar) - Göyüşlü Rəvanə"], 5: ["2)Proqramlaşdırma əsasları (mühazirə) - Sənan Niyazi", "3)İnstrumental proqramlar (mühazirə) - Göyüşlü Rəvanə"] },
            "ust": { 1: ["1)Xətti cəbr (mühazirə) - Səmədzadə Fərahim", "2)Diferensial tənliklər (mühazirə) - Eyyubov Ramazan", "3)Fizika (mühazirə) - Əlizadə Leyla"], 2: ["1)Xətti cəbr (seminar) - Səmədzadə Fərahim", "2)XDİAK-2 (seminar) - Abbasova Nuridə", "3)Proqramlaşdırma (seminar) - Sənan Niyazi"], 3: ["2)XDİAK-2 (seminar) - Abbasova Nuridə", "3)İT əsasları-2 (mühazirə) - Kazımov Ramin"], 4: ["2)Diferensial tənliklər (seminar) - Ramazan Eyyubov", "3)Fizika Seminar (seminar) - Əlizadə Leyla"], 5: ["2)Proqramlaşdırma əsasları (mühazirə) - Sənan Niyazi", "3)İnstrumental proqramlar (mühazirə) - Göyüşlü Rəvanə"] }
        };

        window.dersleriGosterKurs1 = function () {
            let container = document.getElementById("schedule_kurs1");
            if (!container) return;
            container.innerHTML = "";
            const gunler = ["", "1-ci Gün", "2-ci Gün", "3-cü Gün", "4-cü Gün", "5-ci Gün"];

            const renderWeek = (weekType) => {
                container.innerHTML += `<h2 class="text-2xl font-semibold my-4 mt-6 text-center text-yellow-400">${weekType.toUpperCase()} HƏFTƏ</h2>`;
                for (let day = 1; day <= 5; day++) {
                    const lessons = dersCedveliKurs1[weekType][day];
                    const content = lessons ? lessons.map(l => `<div class="bg-gray-700/50 p-2 rounded mt-2">${l}</div>`).join('') : "Dərs yoxdur";
                    container.innerHTML += `<div class="bg-gray-800 p-4 rounded-xl mb-4 border border-gray-700"><strong class="text-blue-300">${gunler[day]}</strong><div class="mt-2 text-gray-300">${content}</div></div>`;
                }
            };
            renderWeek("alt");
            renderWeek("ust");
        }

        // --- Tabs / Navigation ---
        window.showSection = function (id) {
            document.querySelectorAll('.content').forEach(c => c.classList.add('hidden'));
            const el = document.getElementById(id);
            if (el) el.classList.remove('hidden');

            if (id === 'pdfsSection' && document.getElementById("pdf1") && !document.getElementById("pdf1").src) {
                // Load PDFs on demand
                document.getElementById("pdf1").src = "https://drive.google.com/file/d/1nis8yYs2h62nUswOa8qfGGlmHwZUZ0R2/preview";
                document.getElementById("pdf1-download").href = "https://drive.google.com/uc?export=download&id=1nis8yYs2h62nUswOa8qfGGlmHwZUZ0R2";
                document.getElementById("pdf2").src = "https://drive.google.com/file/d/16RVdE5pbYHQap9Em_sIZN2v8T0IJpT_e/preview";
                document.getElementById("pdf2-download").href = "https://drive.google.com/uc?export=download&id=16RVdE5pbYHQap9Em_sIZN2v8T0IJpT_e";
            } else if (id === 'flappySection' && !document.getElementById("flappyIframe")) {
                const f = document.createElement("iframe"); f.id = "flappyIframe"; f.src = "https://kenox7.github.io/FlappyRaminn/"; f.className = "w-full h-full border-none";
                document.getElementById("flappyContainer").appendChild(f);
            } else if (id === 'bagikSection' && !document.getElementById("bagikIframe")) {
                const b = document.createElement("iframe"); b.id = "bagikIframe"; b.src = "https://kenox7.github.io/BagikRun/"; b.className = "w-full h-full border-none";
                document.getElementById("bagikContainer").appendChild(b);
            } else if (id === 'kurs1Section') {
                dersleriGosterKurs1();
            }
        };

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            init(); // Load dynamic schedule
        });
    </script>
</body>

</html>
